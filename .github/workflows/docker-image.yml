name: "Build and Push Docker image"

on:
    push:
        branches: 
            - main
        paths-ignore:
          - '**.md'
          - '.gitignore'
          - '.env.example'
env:
  DOCKER_COMPOSE_VERSION: "2.21.0"  # Pin the version for consistency
  DEPLOY_PATH: "/opt/myapp"         # Standardized deployment path
  COMPOSE_FILE: "/home/ubuntu/Downloads/dockerapp/docker-compose.yaml"

jobs:
    build-and-push:
        name: Build and Push Docker Image
        runs-on: ubuntu-latest

        steps:
            - name: Checkout Code
              uses: actions/checkout@v4
              with:
                fetch-depth: 0
            
            - name: Setup Docker 
              uses: docker/setup-buildx-action@v2

            - name: Dockerhub Login
              uses: docker/login-action@v2
              with:
                username: ${{ secrets.DOCKER_USERNAME }}
                password: ${{secrets.DOCKER_PASSWORD }}

            - name: Build and Push Docker Image 
              uses: docker/build-push-action@v4
              with:
                context: .
                push: true
                tags: ${{ secrets.DOCKER_USERNAME }}/frontend-app:latest

    deploy-to-server:
        needs: build-and-push
        runs-on: ubuntu-latest
        environment: production
        concurrency: 
          group: production_environment
          cancel-in-progress: false
        steps:
          - name: Install SSH Key
            uses: shimataro/ssh-key-action@v2
            with:
              key: ${{ secrets.SSH_PRIVATE_KEY }}
              name: id_rsa
              known_hosts: ${{ secrets.SSH_KNOWN_HOSTS }}
              config: |
                Host production
                HostName ${{ secrets.PRODUCTION_HOST }}
                User ${{ secrets.PRODUCTION_USER }}
                IdentityFile ~/.ssh/id_rsa
                StrictHostKeyChecking no
                
          - name: Install Docker Compose on Production Server
            run: |
              ssh production "
                if ! docker compose version && ! docker-compose version; then
                  sudo apt-get update
                  sudo apt-get install docker-compose-plugin -y || \
                  (sudo curl -L 'https://github.com/docker/compose/releases/download/v2.21.0/docker-compose-$(uname -s)-$(uname -m)' -o /usr/local/bin/docker-compose && sudo chmod +x /usr/local/bin/docker-compose)
                fi"
        
          - name: Setup Remote Directory
            run: |
              ssh production "sudo mkdir -p ${DEPLOY_PATH}/config"
              ssh production "sudo mkdir -p ${DEPLOY_PATH}/data"

                    - name: Copy Configuration Files
            run: |
              if [ -f /home/ubuntu/Downloads/dockerapp/docker-compose.yaml ]; then
                echo "Copying docker-compose.yaml to production server..."
                scp /home/ubuntu/Downloads/dockerapp/docker-compose.yaml production:${DEPLOY_PATH}/docker-compose.yaml
              else
                echo "Error: docker-compose.yaml file not found locally."
                exit 1
              fi
              
              if [ -f .env ]; then
                echo "Copying .env file to production server..."
                scp .env production:${DEPLOY_PATH}/.env
              else
                echo "Warning: .env file not found locally."
              fi

          - name: Verify Deployment Directory
            run: |
              ssh production "
                if [ ! -f ${DEPLOY_PATH}/docker-compose.yaml ]; then
                  echo 'Error: docker-compose.yaml not found in ${DEPLOY_PATH}.'
                  exit 1
                fi

                if [ ! -f ${DEPLOY_PATH}/.env ]; then
                  echo 'Warning: .env file not found in ${DEPLOY_PATH}.'
                fi
              "

          - name: Deploy to Production
            run: |
              cat << 'EOF' > deploy.sh
              #!/bin/bash
              set -e

              if [ -f .env ]; then
                  set -a
                  source .env
                  set +a
              else
                  echo "Warning: .env file not found. Proceeding without environment variables."
              fi

              if command -v docker-compose &> /dev/null; then
                  DOCKER_COMPOSE_CMD="docker-compose"
              else
                  DOCKER_COMPOSE_CMD="docker compose"
              fi
              
              $DOCKER_COMPOSE_CMD -f docker-compose.yaml pull
              $DOCKER_COMPOSE_CMD -f docker-compose.yaml config
              $DOCKER_COMPOSE_CMD -f docker-compose.yaml up -d --remove-orphans
              
              timeout 60s bash -c "until $DOCKER_COMPOSE_CMD ps | grep -q '(healthy)'; do sleep 2; done"
              
              docker system prune -af --volumes
              EOF
              
              ssh production "sudo mkdir -p ${DEPLOY_PATH} && sudo chown -R azureuser:azureuser ${DEPLOY_PATH}"
              scp deploy.sh production:${DEPLOY_PATH}/deploy.sh
              ssh production "cd ${DEPLOY_PATH} && chmod +x deploy.sh && ./deploy.sh"
